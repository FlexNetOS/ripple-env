{
  "name": "ripple-env (NixOS)",

  // Use custom Dockerfile based on nixos/nix
  "build": {
    "dockerfile": "Dockerfile",
    "context": ".."
  },

  // ==========================================================================
  // Environment Configuration
  // ==========================================================================
  // All tools installed via Nix in Dockerfile for consistency with WSL NixOS
  // and local Nix environments.
  //
  // Node.js and Cargo run through pixi for cross-platform dependency management.
  // See pixi.toml for Node.js (>=22.0) and package.json for npm scripts.
  // Rust toolchain is provided via Nix (cargo, rustc, rust-analyzer).
  //
  // Supported configurations:
  // - Nix: flake.nix defines devShells (default, full, cuda, identity)
  // - Pixi: pixi.toml manages Python, Node.js, and ROS2 dependencies
  // - Direnv: .envrc auto-loads the Nix development environment
  // - Home-manager: home.nix provides user configuration management
  // - Nushell: Modern shell with structured data support

  "mounts": [
    // Persistent Nix store for faster rebuilds
    "source=ripple-env-nix-store,target=/nix,type=volume",
    // Pixi cache persistence
    "source=ripple-env-pixi-cache,target=/home/vscode/.pixi,type=volume",
    // Local bin persistence (pip, cargo installs)
    "source=ripple-env-local-bin,target=/home/vscode/.local,type=volume",
    // Home-manager configuration persistence
    "source=ripple-env-home-manager,target=/home/vscode/.config/home-manager,type=volume"
  ],

  "remoteUser": "vscode",
  "updateRemoteUserUID": true,

  "containerEnv": {
    "TMPDIR": "/tmp",
    "TMP": "/tmp",
    "TEMP": "/tmp",
    "PIXI_HOME": "/home/vscode/.pixi",
    "EDITOR": "hx",
    "VISUAL": "hx",
    // Home-manager integration
    "HOME_MANAGER_CONFIG": "/home/vscode/.config/home-manager/home.nix",
    // Ripple environment paths
    "RIPPLE_ENV_CACHE": "/home/vscode/.cache/ripple-env",
    "RIPPLE_ENV_CONFIG": "/home/vscode/.config/ripple-env"
  },

  // Ensure proper permissions on mounted volumes
  "onCreateCommand": "sudo chown -R vscode:vscode /home/vscode/.pixi /home/vscode/.local /home/vscode/.config 2>/dev/null || true",

  // Setup workspace environment
  "postCreateCommand": ".devcontainer/setup.sh",

  // Start shell automatically with direnv
  "postStartCommand": "direnv allow . 2>/dev/null || true",

  "customizations": {
    "vscode": {
      "settings": {
        // Terminal configuration - multiple shell options (Nushell, Zsh, Bash)
        "terminal.integrated.defaultProfile.linux": "zsh",
        "terminal.integrated.profiles.linux": {
          "zsh": {
            "path": "/nix/var/nix/profiles/default/bin/zsh",
            "icon": "terminal"
          },
          "bash": {
            "path": "/nix/var/nix/profiles/default/bin/bash",
            "icon": "terminal-bash"
          },
          "nushell": {
            "path": "/nix/var/nix/profiles/default/bin/nu",
            "icon": "terminal-powershell"
          }
        },
        "terminal.integrated.shellIntegration.enabled": true,
        "terminal.integrated.scrollback": 10000,

        // Editor settings
        "files.eol": "\n",
        "files.insertFinalNewline": true,
        "files.trimTrailingWhitespace": true,
        "editor.formatOnSave": true,
        "editor.tabSize": 2,

        // Git settings
        "git.enableCommitSigning": false,
        "git.autofetch": true,

        // Nix settings (nil language server installed via Nix)
        "nix.enableLanguageServer": true,
        "nix.serverPath": "/nix/var/nix/profiles/default/bin/nil",
        "nix.formatterPath": "/nix/var/nix/profiles/default/bin/nixfmt",
        "nix.serverSettings": {
          "nil": {
            "formatting": {
              "command": ["/nix/var/nix/profiles/default/bin/nixfmt"]
            }
          }
        },

        // Python settings (via Pixi environment)
        "python.defaultInterpreterPath": "${workspaceFolder}/.pixi/envs/default/bin/python",
        "[python]": {
          "editor.defaultFormatter": "charliermarsh.ruff",
          "editor.formatOnSave": true
        },

        // Rust settings (Rust toolchain via Nix)
        "rust-analyzer.cargo.buildScripts.enable": true,
        "rust-analyzer.procMacro.enable": true,
        "[rust]": {
          "editor.defaultFormatter": "rust-lang.rust-analyzer",
          "editor.formatOnSave": true
        },

        // Node.js / JavaScript / TypeScript settings (Node.js via Pixi)
        "[javascript]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode",
          "editor.formatOnSave": true
        },
        "[typescript]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode",
          "editor.formatOnSave": true
        },
        "[json]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode",
          "editor.formatOnSave": true
        },
        "[jsonc]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode",
          "editor.formatOnSave": true
        },

        // YAML / TOML settings
        "[yaml]": {
          "editor.defaultFormatter": "redhat.vscode-yaml",
          "editor.formatOnSave": true
        },
        "[toml]": {
          "editor.defaultFormatter": "tamasfe.even-better-toml",
          "editor.formatOnSave": true
        },
        "[markdown]": {
          "editor.wordWrap": "on",
          "files.trimTrailingWhitespace": false
        },

        // C/C++ settings
        // Note: In this devcontainer, /nix/var/nix/profiles/default/bin/gcc resolves to gcc13 installed in the Dockerfile.
        // If you change the installed GCC version or need a different one, update this path to the appropriate gcc binary in the same profile.
        "C_Cpp.default.compilerPath": "/nix/var/nix/profiles/default/bin/gcc",
        "C_Cpp.default.cStandard": "c17",
        "C_Cpp.default.cppStandard": "c++20",
        "[cpp]": {
          "editor.formatOnSave": true
        },
        "[c]": {
          "editor.formatOnSave": true
        },

        // Direnv auto-reload
        "direnv.restart.automatic": true,
        "direnv.path.executable": "/nix/var/nix/profiles/default/bin/direnv",

        // ShellCheck for shell scripts
        "shellcheck.enable": true
      },
      "extensions": [
        // Nix ecosystem
        "jnoortheen.nix-ide",
        "mkhl.direnv",

        // Shell & scripting (Nushell, Bash, PowerShell)
        "timonwong.shellcheck",
        "thenuprojectcontributors.vscode-nushell-lang",
        "ms-vscode.powershell",

        // Python (via Pixi)
        "ms-python.python",
        "ms-python.vscode-pylance",
        "charliermarsh.ruff",

        // Rust (via Nix)
        "rust-lang.rust-analyzer",
        "vadimcn.vscode-lldb",
        "serayuzgur.crates",

        // Node.js / JavaScript / TypeScript (via Pixi)
        "dbaeumer.vscode-eslint",
        "esbenp.prettier-vscode",

        // Data & Config formats
        "redhat.vscode-yaml",
        "tamasfe.even-better-toml",

        // Kubernetes & Docker
        "ms-kubernetes-tools.vscode-kubernetes-tools",
        "ms-azuretools.vscode-docker",

        // Protocol Buffers / gRPC
        "zxh404.vscode-proto3",

        // Git & GitHub
        "github.vscode-pull-request-github",
        "eamodio.gitlens",

        // ROS
        "ms-iot.vscode-ros",

        // C/C++
        "ms-vscode.cpptools",
        "ms-vscode.cmake-tools",

        // Editor utilities
        "editorconfig.editorconfig",
        "usernamehw.errorlens",
        "christian-kohler.path-intellisense"
      ]
    },
    "codespaces": {
      "openFiles": [
        "README.md"
      ]
    }
  },

  // Resource limits for Codespaces
  "hostRequirements": {
    "cpus": 4,
    "memory": "8gb",
    "storage": "32gb"
  }
}
