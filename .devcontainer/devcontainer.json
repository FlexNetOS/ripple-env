{
  "name": "ripple-env (NixOS)",

  // Use custom Dockerfile based on nixos/nix
  "build": {
    "dockerfile": "Dockerfile",
    "context": ".."
  },

  // No features needed - everything installed via Nix in Dockerfile
  // This provides consistency with WSL NixOS and local Nix environments

  "mounts": [
    // Persistent Nix store for faster rebuilds
    "source=ripple-env-nix-store,target=/nix,type=volume",
    // Pixi cache persistence
    "source=ripple-env-pixi-cache,target=/home/vscode/.pixi,type=volume",
    // Local bin persistence
    "source=ripple-env-local-bin,target=/home/vscode/.local,type=volume"
  ],

  "remoteUser": "vscode",
  "updateRemoteUserUID": true,

  "containerEnv": {
    "TMPDIR": "/tmp",
    "TMP": "/tmp",
    "TEMP": "/tmp",
    "PIXI_HOME": "/home/vscode/.pixi",
    "EDITOR": "hx",
    "VISUAL": "hx"
  },

  // Ensure proper permissions on mounted volumes
  "onCreateCommand": "sudo chown -R vscode:vscode /home/vscode/.pixi /home/vscode/.local 2>/dev/null || true",

  // Setup workspace environment
  "postCreateCommand": ".devcontainer/setup.sh",

  // Start shell automatically
  "postStartCommand": "direnv allow . 2>/dev/null || true",

  "customizations": {
    "vscode": {
      "settings": {
        // Terminal configuration - multiple shell options
        "terminal.integrated.defaultProfile.linux": "zsh",
        "terminal.integrated.profiles.linux": {
          "zsh": {
            "path": "/nix/var/nix/profiles/default/bin/zsh",
            "icon": "terminal"
          },
          "bash": {
            "path": "/nix/var/nix/profiles/default/bin/bash",
            "icon": "terminal-bash"
          },
          "nushell": {
            "path": "/nix/var/nix/profiles/default/bin/nu",
            "icon": "terminal-powershell"
          }
        },
        "terminal.integrated.shellIntegration.enabled": true,

        // Editor settings
        "files.eol": "\n",
        "editor.formatOnSave": true,
        "editor.tabSize": 2,

        // Git settings
        "git.enableCommitSigning": false,
        "git.autofetch": true,

        // Nix settings (nil language server installed via Nix)
        "nix.enableLanguageServer": true,
        "nix.serverPath": "/nix/var/nix/profiles/default/bin/nil",
        "nix.serverSettings": {
          "nil": {
            "formatting": {
              "command": ["/nix/var/nix/profiles/default/bin/nixfmt"]
            }
          }
        },

        // Python settings (via Pixi environment)
        "python.defaultInterpreterPath": "${workspaceFolder}/.pixi/envs/default/bin/python",
        "[python]": {
          "editor.defaultFormatter": "charliermarsh.ruff",
          "editor.formatOnSave": true
        },

        // Rust settings
        "rust-analyzer.server.path": "/nix/var/nix/profiles/default/bin/rust-analyzer",
        "rust-analyzer.cargo.buildScripts.enable": true,
        "rust-analyzer.procMacro.enable": true,
        "[rust]": {
          "editor.defaultFormatter": "rust-lang.rust-analyzer",
          "editor.formatOnSave": true
        },

        // Node.js / JavaScript / TypeScript settings
        "[javascript]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode",
          "editor.formatOnSave": true
        },
        "[typescript]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode",
          "editor.formatOnSave": true
        },
        "[json]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode",
          "editor.formatOnSave": true
        },

        // C/C++ settings
        // Note: This uses the default GCC from the Nix profile at /nix/var/nix/profiles/default/bin/gcc.
        // If you specifically need gcc13 for certain C++20 features, update this path to the gcc13 binary in the same profile.
        "C_Cpp.default.compilerPath": "/nix/var/nix/profiles/default/bin/gcc",
        "C_Cpp.default.cStandard": "c17",
        "C_Cpp.default.cppStandard": "c++20",
        "[cpp]": {
          "editor.formatOnSave": true
        },
        "[c]": {
          "editor.formatOnSave": true
        },

        // Direnv auto-reload
        "direnv.restart.automatic": true,
        "direnv.path.executable": "/nix/var/nix/profiles/default/bin/direnv"
      },
      "extensions": [
        // Nix ecosystem
        "jnoortheen.nix-ide",
        "mkhl.direnv",

        // Shell & scripting
        "timonwong.shellcheck",
        "thenuprojectcontributors.vscode-nushell-lang",

        // Python
        "ms-python.python",
        "ms-python.vscode-pylance",
        "charliermarsh.ruff",

        // Rust
        "rust-lang.rust-analyzer",
        "vadimcn.vscode-lldb",
        "serayuzgur.crates",

        // Node.js / JavaScript / TypeScript
        "dbaeumer.vscode-eslint",
        "esbenp.prettier-vscode",

        // Data & Config formats
        "redhat.vscode-yaml",
        "tamasfe.even-better-toml",

        // Kubernetes
        "ms-kubernetes-tools.vscode-kubernetes-tools",

        // Docker & Containers
        "ms-azuretools.vscode-docker",

        // Protocol Buffers / gRPC
        "zxh404.vscode-proto3",

        // Git & GitHub
        "github.vscode-pull-request-github",
        "eamodio.gitlens",

        // ROS
        "ms-iot.vscode-ros",

        // C/C++
        "ms-vscode.cpptools",
        "ms-vscode.cmake-tools",

        // Editor utilities
        "editorconfig.editorconfig",
        "usernamehw.errorlens",
        "christian-kohler.path-intellisense"
      ]
    },
    "codespaces": {
      "openFiles": [
        "README.md"
      ]
    }
  },

  // Resource limits for Codespaces
  "hostRequirements": {
    "cpus": 4,
    "memory": "8gb",
    "storage": "32gb"
  }
}
