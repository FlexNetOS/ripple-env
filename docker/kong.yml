# Kong - API Gateway and Ingress Controller (BUILDKIT L4)
# P2-002: Kong provides North-South edge gateway for external traffic
#
# Kong features:
#   - API routing and load balancing
#   - Authentication and authorization
#   - Rate limiting and throttling
#   - Request/response transformation
#   - Logging and monitoring
#   - Plugin ecosystem
#   - Declarative configuration
#
# Components:
#   - Kong Gateway: Main proxy server
#   - PostgreSQL: Database for configuration
#   - Kong Manager: Admin UI (Enterprise)
#   - Kong Portal: Developer portal (Enterprise)
#
# References:
#   - https://docs.konghq.com
#   - https://github.com/Kong/kong
#   - BUILDKIT_STARTER_SPEC.md L4: Edge & Agent Traffic

services:
  # Kong Gateway
  kong:
    image: kong:3.5
    container_name: kong
    restart: unless-stopped
    
    # Environment variables
    environment:
      # Database configuration
      KONG_DATABASE: postgres
      KONG_PG_HOST: postgres
      KONG_PG_PORT: 5432
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PG_DATABASE: kong
      
      # General configuration
      KONG_LOG_LEVEL: info
      KONG_PREFIX: /usr/local/kong
      
      # Proxy configuration
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      
      # Admin API
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      
      # Proxy listeners
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl
      KONG_STREAM_LISTEN: "off"
      
      # Status API
      KONG_STATUS_LISTEN: 0.0.0.0:8100
      
      # DNS resolution
      KONG_DNS_RESOLVER: 127.0.0.11
      
      # Nginx worker processes
      KONG_NGINX_WORKER_PROCESSES: auto
      
      # Nginx worker connections
      KONG_NGINX_WORKER_CONNECTIONS: 1024
      
      # Nginx worker backlog
      KONG_NGINX_WORKER_BACKLOG: 16384
      
      # Nginx worker CPU affinity
      KONG_NGINX_WORKER_CPU_AFFINITY: auto
      
      # LuaJIT
      KONG_LUJIT: 1
      
      # Anonymous reports
      KONG_ANONYMOUS_REPORTS: "false"
      
      # Declarative configuration (for DB-less mode)
      # KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      
      # Plugins
      KONG_PLUGINS: bundled
      
      # Headers
      KONG_HEADERS: server_tokens,latency_tokens
      
      # Trusted IPs
      KONG_TRUSTED_IPS: 0.0.0.0/0,::/0
      
      # Real IP header
      KONG_REAL_IP_HEADER: X-Forwarded-For
      
      # Real IP recursive
      KONG_REAL_IP_RECURSIVE: "on"
      
      # Client SSL (for upstream mTLS)
      # KONG_NGINX_PROXY_SSL_VERIFY: "off"
      # KONG_NGINX_PROXY_SSL_VERIFY_DEPTH: 1
      
      # Upstream SSL
      KONG_NGINX_UPSTREAM_SSL_VERIFY: "off"
      KONG_NGINX_UPSTREAM_SSL_VERIFY_DEPTH: 1
      
      # Lua SSL
      KONG_LUA_SSL_VERIFY_DEPTH: 1
      
      # Client body buffer size
      KONG_CLIENT_BODY_BUFFER_SIZE: 8k
      
      # Client max body size
      KONG_CLIENT_MAX_BODY_SIZE: 0
      
      # Upstream keepalive
      KONG_UPSTREAM_KEEPALIVE_POOL_SIZE: 60
      KONG_UPSTREAM_KEEPALIVE_MAX_REQUESTS: 100
      KONG_UPSTREAM_KEEPALIVE_TIMEOUT: 60s
    
    # Ports
    ports:
      - "8000:8000"  # Proxy HTTP
      - "8443:8443"  # Proxy HTTPS
      - "8001:8001"  # Admin API
      - "8002:8002"  # Admin GUI
      - "8003:8003"  # Admin GUI HTTPS
      - "8100:8100"  # Status API
    
    # Volumes
    volumes:
      # Configuration
      - ./config/kong:/usr/local/kong
      # Declarative configuration
      - ./config/kong/declarative:/kong/declarative
      # Custom plugins
      - ./config/kong/plugins:/usr/local/kong/plugins
      # SSL certificates
      - ./config/kong/ssl:/usr/local/kong/ssl
      # Logs
      - ./logs/kong:/usr/local/kong/logs
    
    # Health check
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Security settings
    security_opt:
      - no-new-privileges:true
    
    # Network
    networks:
      - kong-network
    
    # Labels for documentation and management
    labels:
      - "service=kong"
      - "layer=L4-Edge-Agent-Traffic"
      - "description=Kong API Gateway"
      - "traefik.enable=true"
      - "traefik.http.routers.kong.rule=Host(`api.localhost`)"
      - "traefik.http.routers.kong.entrypoints=web"
      - "traefik.http.services.kong.loadbalancer.server.port=8000"

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: kong-postgres
    restart: unless-stopped
    
    # Environment variables
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
      
      # Performance tuning
      POSTGRES_SHARED_PRELOAD_LIBRARIES: pg_stat_statements
      POSTGRES_MAX_CONNECTIONS: 200
      POSTGRES_WORK_MEM: 4MB
    
    # Volumes
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Initialization scripts
      - ./config/kong/postgres/init:/docker-entrypoint-initdb.d
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 256M
    
    # Network
    networks:
      - kong-network
    
    # Labels
    labels:
      - "service=postgres"
      - "layer=L10-State-Storage"
      - "description=PostgreSQL database for Kong"

  # Kong Migration (one-time setup)
  kong-migration:
    image: kong:3.5
    container_name: kong-migration
    restart: "no"
    
    # Environment variables
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: postgres
      KONG_PG_PORT: 5432
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PG_DATABASE: kong
    
    # Command
    command: kong migrations bootstrap
    
    # Dependencies
    depends_on:
      postgres:
        condition: service_healthy
    
    # Network
    networks:
      - kong-network
    
    # Labels
    labels:
      - "service=kong-migration"
      - "layer=L4-Edge-Agent-Traffic"
      - "description=Kong database migration (one-time)"

# Volumes
volumes:
  postgres-data:
    driver: local

# Networks
networks:
  kong-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.27.0.0/16