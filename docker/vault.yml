# HashiCorp Vault - Secrets Management (BUILDKIT L5)
# P0-003: Vault is required for secrets management and dynamic credentials
#
# Vault provides:
#   - Secret storage with encryption at rest
#   - Dynamic credentials (database, cloud, API keys)
#   - PKI certificate management
#   - Identity and access management
#   - Audit logging for compliance
#
# Security features:
#   - Root token is only shown once at initialization
#   - All data encrypted with AES-256-GCM
#   - Supports multiple authentication methods
#   - Built-in audit logging
#
# References:
#   - https://www.vaultproject.io/docs
#   - https://github.com/hashicorp/vault
#   - BUILDKIT_STARTER_SPEC.md L5: Identity & Policy

services:
  vault:
    image: hashicorp/vault:1.15.4
    container_name: vault
    restart: unless-stopped
    
    # Security: Run as non-root user
    user: vault
    
    # Capabilities needed for Vault
    cap_add:
      - IPC_LOCK  # Required for Vault's memory locking
    
    # Environment variables
    environment:
      # Development mode (single node, in-memory storage)
      # For production: use file storage and clustering
      VAULT_DEV_ROOT_TOKEN_ID: dev-root-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      
      # General Vault configuration
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_API_ADDR: http://vault:8200
      
      # Logging
      VAULT_LOG_LEVEL: info
      
      # Security headers
      VAULT_DISABLE_MLOCK: "false"  # Keep memory locking enabled
    
    # Ports
    ports:
      - "8200:8200"  # Vault API and UI
    
    # Volumes for persistent storage
    volumes:
      # Vault data (for dev mode, this is in-memory but volume for consistency)
      - vault-data:/vault/data
      # Vault configuration
      - ./config/vault:/vault/config:ro
      # Audit logs
      - ./logs/vault:/vault/logs
    
    # Health check
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Security settings
    security_opt:
      - no-new-privileges:true
    
    # Network
    networks:
      - vault-network
    
    # Labels for documentation and management
    labels:
      - "service=vault"
      - "layer=L5-Identity-Policy"
      - "description=HashiCorp Vault secrets management"
      - "traefik.enable=true"
      - "traefik.http.routers.vault.rule=Host(`vault.localhost`)"
      - "traefik.http.routers.vault.entrypoints=web"
      - "traefik.http.services.vault.loadbalancer.server.port=8200"

# Volumes
volumes:
  vault-data:
    driver: local

# Networks
networks:
  vault-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16