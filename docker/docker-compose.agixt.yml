# AGiXT Docker Compose Configuration
# Documentation: docs/adr/adr-006-agixt-integration.md
#
# Resource Requirements (Total):
#   - RAM: 8GB minimum (all services)
#   - CPU: 8 cores recommended
#   - Disk: 12GB+ for data
#
# Validate resources: ./scripts/validate-resources.sh --profile standard
# See docs/AI_RESOURCE_REQUIREMENTS.md for detailed requirements
#
# Usage:
#   agixt up      - Start all services
#   agixt down    - Stop all services
#   agixt logs    - Follow logs
#   agixt status  - Show service status
#
# Services:
#   - AGiXT API (port 7437) - Main API server (4GB RAM limit)
#   - AGiXT Interactive (port 3437) - Next.js UI (1GB RAM limit)
#   - PostgreSQL (port 5432) - Agent memory and data (2GB RAM limit)
#   - MinIO (ports 9000/9001) - S3-compatible object storage (1GB RAM limit)
#
# Integration with LocalAI:
#   AGiXT uses LocalAI (running on host) as OpenAI-compatible provider
#   Configure via OPENAI_API_BASE=http://host.docker.internal:8080/v1

name: agixt

services:
  # AGiXT API Server
  agixt:
    image: joshxt/agixt:main
    container_name: agixt-api
    restart: unless-stopped
    # Resource limits for performance monitoring
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    ports:
      - "7437:7437"
    environment:
      # Core settings
      AGIXT_API_KEY: ${AGIXT_API_KEY:-agixt-dev-key}
      AGIXT_URI: http://agixt:7437
      UVICORN_WORKERS: ${UVICORN_WORKERS:-4}

      # Database connection
      DB_CONNECTED: "true"
      DATABASE_TYPE: postgresql
      DATABASE_NAME: agixt
      DATABASE_USER: agixt
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-agixt-dev-password}
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432

      # S3/MinIO storage
      USING_S3: "true"
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      AWS_REGION: us-east-1
      S3_BUCKET: agixt
      S3_ENDPOINT_URL: http://minio:9000

      # LocalAI integration (running on host via Nix)
      # Use host.docker.internal to reach LocalAI on the host machine
      OPENAI_API_BASE: ${OPENAI_API_BASE:-http://host.docker.internal:8080/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-localai}

      # Default AI provider settings
      DEFAULT_PROVIDER: openai
      DEFAULT_MODEL: ${DEFAULT_MODEL:-ggml-gpt4all-j}

      # Security
      ALLOWED_DOMAINS: "*"
      AUTH_PROVIDER: none

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: JSON

    volumes:
      - ./agixt-data/models:/agixt/models
      - ./agixt-data/workspace:/agixt/WORKSPACE
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - agixt-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7437/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Resource limits for AGiXT API
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # AGiXT Interactive UI
  agixt-interactive:
    image: joshxt/agixt-interactive:main
    container_name: agixt-ui
    restart: unless-stopped
    ports:
      - "3437:3437"
    environment:
      AGIXT_SERVER: http://agixt:7437
      AGIXT_API_KEY: ${AGIXT_API_KEY:-agixt-dev-key}
    depends_on:
      - agixt
    networks:
      - agixt-network
    # Resource limits for UI
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M

  # PostgreSQL Database
  postgres:
    image: postgres:17.2-alpine
    container_name: agixt-postgres
    restart: unless-stopped
    # Resource limits for performance monitoring
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: agixt
      POSTGRES_USER: agixt
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-agixt-dev-password}
    volumes:
      - ./agixt-data/postgres:/var/lib/postgresql/data
    networks:
      - agixt-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agixt -d agixt"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Resource limits for PostgreSQL
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # MinIO S3-compatible Storage
  minio:
    image: minio/minio:RELEASE.2024-12-18T13-15-44Z
    container_name: agixt-minio
    restart: unless-stopped
    # Resource limits for performance monitoring
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console UI
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - ./agixt-data/minio:/data
    networks:
      - agixt-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Resource limits for MinIO
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M

  # MinIO setup - creates the agixt bucket on first run
  minio-setup:
    image: minio/mc:RELEASE.2024-12-18T15-11-58Z
    container_name: agixt-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER:-minioadmin} $${MINIO_ROOT_PASSWORD:-minioadmin};
        mc mb --ignore-existing myminio/agixt;
        mc anonymous set download myminio/agixt;
        exit 0;
      "
    networks:
      - agixt-network

networks:
  agixt-network:
    driver: bridge

# Persistent volumes for data
volumes:
  agixt-models:
  agixt-workspace:
  postgres-data:
  minio-data:
