name: AGiXT Integration Test

on:
  push:
    branches: [main]
    paths:
      - 'docker/agixt.yml'
      - 'config/agixt/**'
      - 'scripts/health-check.sh'
      - '.github/workflows/agixt-test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docker/agixt.yml'
      - 'config/agixt/**'
      - 'scripts/health-check.sh'
      - '.github/workflows/agixt-test.yml'
  workflow_dispatch:

env:
  AGIXT_API_KEY: 'test-api-key'

jobs:
  test-agixt:
    name: AGiXT Service Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Docker network
        run: docker network create agentic-network || true

      - name: Prepare health check script
        run: chmod +x scripts/health-check.sh

      - name: Start AGiXT dependencies
        id: deps
        run: |
          echo "Starting PostgreSQL and Redis..."
          docker compose -f docker/agixt.yml up -d postgres redis
          sleep 10
          echo "deps_status=started" >> $GITHUB_OUTPUT

      - name: Start AGiXT
        id: agixt
        run: |
          docker compose -f docker/agixt.yml up -d
          echo "AGiXT containers started, waiting for initialization..."
          echo "agixt_status=started" >> $GITHUB_OUTPUT

      - name: Wait for AGiXT API readiness
        id: health
        run: |
          if ./scripts/health-check.sh http://localhost:7437/api/health 10 15 "AGiXT API"; then
            echo "health_status=healthy" >> $GITHUB_OUTPUT
          else
            echo "AGiXT health endpoint not responding, checking alternative endpoints..."
            if ./scripts/health-check.sh http://localhost:7437/api/v1/providers 5 10 "AGiXT Providers API"; then
              echo "health_status=degraded" >> $GITHUB_OUTPUT
            else
              echo "health_status=unhealthy" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Test AGiXT API endpoints
        id: endpoints
        run: |
          results=""

          # Test providers endpoint
          if ./scripts/health-check.sh http://localhost:7437/api/v1/providers 3 5 "AGiXT Providers" 2>/dev/null; then
            results="${results}providers:pass,"
          else
            results="${results}providers:fail,"
          fi

          # Test extensions endpoint
          if ./scripts/health-check.sh http://localhost:7437/api/v1/extensions 3 5 "AGiXT Extensions" 2>/dev/null; then
            results="${results}extensions:pass,"
          else
            results="${results}extensions:fail,"
          fi

          # Test chains endpoint
          if ./scripts/health-check.sh http://localhost:7437/api/v1/chains 3 5 "AGiXT Chains" 2>/dev/null; then
            results="${results}chains:pass"
          else
            results="${results}chains:fail"
          fi

          echo "endpoint_results=${results}" >> $GITHUB_OUTPUT

      - name: List available providers
        run: |
          echo "Available AGiXT providers:"
          curl -sf http://localhost:7437/api/v1/providers 2>/dev/null | jq '.' || echo "Could not fetch providers"

      - name: Test agent creation (dry run)
        id: agent
        run: |
          response=$(curl -sf -X POST http://localhost:7437/api/v1/agent \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $AGIXT_API_KEY" \
            -d '{
              "agent_name": "test-agent",
              "provider": "gpt4free",
              "settings": {}
            }' 2>&1) && echo "agent_status=created" >> $GITHUB_OUTPUT || echo "agent_status=skipped" >> $GITHUB_OUTPUT

      - name: Generate Job Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ¤– AGiXT Service Test Results

          ### Service Status
          | Service | Status |
          |---------|--------|
          | Dependencies (PostgreSQL, Redis) | ${{ steps.deps.outputs.deps_status == 'started' && 'âœ… Started' || 'âŒ Failed' }} |
          | AGiXT API | ${{ steps.agixt.outputs.agixt_status == 'started' && 'âœ… Started' || 'âŒ Failed' }} |
          | Health Check | ${{ steps.health.outputs.health_status == 'healthy' && 'âœ… Healthy' || (steps.health.outputs.health_status == 'degraded' && 'âš ï¸ Degraded' || 'âŒ Unhealthy') }} |

          ### API Endpoint Tests
          EOF

          # Parse endpoint results
          results="${{ steps.endpoints.outputs.endpoint_results }}"
          echo "| Endpoint | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "$results" == *"providers:pass"* ]]; then
            echo "| /api/v1/providers | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| /api/v1/providers | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$results" == *"extensions:pass"* ]]; then
            echo "| /api/v1/extensions | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| /api/v1/extensions | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$results" == *"chains:pass"* ]]; then
            echo "| /api/v1/chains | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| /api/v1/chains | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ### Agent Creation Test
          EOF

          if [[ "${{ steps.agent.outputs.agent_status }}" == "created" ]]; then
            echo "âœ… Agent created successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Agent creation skipped (no provider configured - expected in CI)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Collect AGiXT logs
        if: always()
        run: |
          echo "=== AGiXT API Logs ==="
          docker logs agixt 2>&1 | tail -100 || true
          echo ""
          echo "=== PostgreSQL Logs ==="
          docker logs agixt-postgres 2>&1 | tail -50 || true
          echo ""
          echo "=== Redis Logs ==="
          docker logs agixt-redis 2>&1 | tail -50 || true

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/agixt.yml down -v || true
          docker network rm agentic-network || true

  test-agixt-config:
    name: AGiXT Configuration Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Validate AGiXT docker-compose
        id: compose
        run: |
          if docker compose -f docker/agixt.yml config > /dev/null 2>&1; then
            echo "compose_valid=true" >> $GITHUB_OUTPUT
          else
            echo "compose_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check AGiXT configuration files
        id: configs
        run: |
          valid_count=0
          invalid_count=0
          invalid_files=""

          if [ -d "config/agixt" ]; then
            while IFS= read -r f; do
              if [[ "$f" == *.json ]]; then
                if python3 -c "import json; json.load(open('$f'))" 2>/dev/null; then
                  ((valid_count++))
                else
                  ((invalid_count++))
                  invalid_files="${invalid_files}${f},"
                fi
              else
                if python3 -c "import yaml; yaml.safe_load(open('$f'))" 2>/dev/null; then
                  ((valid_count++))
                else
                  ((invalid_count++))
                  invalid_files="${invalid_files}${f},"
                fi
              fi
            done < <(find config/agixt -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.json" \))
          fi

          echo "valid_count=${valid_count}" >> $GITHUB_OUTPUT
          echo "invalid_count=${invalid_count}" >> $GITHUB_OUTPUT
          echo "invalid_files=${invalid_files}" >> $GITHUB_OUTPUT

          if [ "$invalid_count" -gt 0 ]; then
            exit 1
          fi

      - name: Check environment variables
        run: |
          echo "Checking required environment variables in docker/agixt.yml..."
          grep -E "^\s+\w+:" docker/agixt.yml | grep -E "(POSTGRES|AGIXT|OPENAI|API)" | head -20 || true

      - name: Generate Job Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“‹ AGiXT Configuration Test Results

          ### Docker Compose Validation
          EOF

          if [[ "${{ steps.compose.outputs.compose_valid }}" == "true" ]]; then
            echo "âœ… \`docker/agixt.yml\` is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ \`docker/agixt.yml\` has syntax errors" >> $GITHUB_STEP_SUMMARY
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ### Configuration Files
          | Metric | Count |
          |--------|-------|
          EOF

          echo "| Valid configs | ${{ steps.configs.outputs.valid_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Invalid configs | ${{ steps.configs.outputs.invalid_count }} |" >> $GITHUB_STEP_SUMMARY

          if [[ -n "${{ steps.configs.outputs.invalid_files }}" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Invalid files:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.configs.outputs.invalid_files }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
