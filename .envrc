# ripple-env direnv configuration
# This file automatically loads the development environment
#
# Usage:
#   direnv allow    # Enable this environment
#   direnv reload   # Reload after changes
#
# For more info: https://direnv.net/

# =============================================================================
# Temporary Directory Setup
# =============================================================================
# Some environments set TMPDIR/TMP/TEMP to a path that may not exist.
# Nix (and some installers) rely on these being valid directories.
if [[ -z "${TMPDIR:-}" ]]; then
  export TMPDIR=/tmp
fi
if [[ ! -d "${TMPDIR}" ]]; then
  mkdir -p "${TMPDIR}" 2>/dev/null || export TMPDIR=/tmp
fi
export TMP="${TMPDIR}"
export TEMP="${TMPDIR}"

# =============================================================================
# Nix Flake Development Shell
# =============================================================================
# This loads the default devShell from flake.nix
# For alternative shells use: use flake .#full or use flake .#cuda
use flake

# =============================================================================
# Home Manager Integration
# =============================================================================
# Check if home-manager is available and configured
if command -v home-manager >/dev/null 2>&1; then
  # Set up home-manager environment
  export HOME_MANAGER_CONFIG="$HOME/.config/home-manager/home.nix"
  
  # Check if home-manager config exists
  if [[ -f "$HOME_MANAGER_CONFIG" ]]; then
    echo "üè† Home Manager configuration found at $HOME_MANAGER_CONFIG"
    echo "   Run 'home-manager switch' to apply changes"
  else
    echo "üè† No Home Manager configuration found"
    echo "   Copy home.nix template to $HOME_MANAGER_CONFIG to get started"
  fi
fi

# =============================================================================
# Ripple Environment Setup
# =============================================================================
# Set up ripple-specific environment variables
export RIPPLE_ENV_ROOT="$(pwd)"
export RIPPLE_ENV_CACHE="$HOME/.cache/ripple-env"
export RIPPLE_ENV_CONFIG="$HOME/.config/ripple-env"

# Create cache and config directories if they don't exist
mkdir -p "$RIPPLE_ENV_CACHE"
mkdir -p "$RIPPLE_ENV_CONFIG"

# =============================================================================
# Development Environment Validation
# =============================================================================
# Check if essential tools are available
echo "üîß Validating ripple-env development environment..."

# Check pixi
if command -v pixi >/dev/null 2>&1; then
  echo "‚úÖ Pixi: $(pixi --version)"
else
  echo "‚ö†Ô∏è  Pixi: Not found (install with: nix develop .#default)"
fi

# Check ROS2 tools
if command -v ros2 >/dev/null 2>&1; then
  echo "‚úÖ ROS2: $(ros2 --version 2>/dev/null || echo 'available')"
else
  echo "‚ö†Ô∏è  ROS2: Not found (activate pixi environment)"
fi

# Check development tools
essential_tools=("git" "docker" "nix")
for tool in "${essential_tools[@]}"; do
  if command -v "$tool" >/dev/null 2>&1; then
    echo "‚úÖ $tool: Available"
  else
    echo "‚ö†Ô∏è  $tool: Not found"
  fi
done

# =============================================================================
# Optional Tool Detection
# =============================================================================
echo ""
echo "üîç Optional tools:"

optional_tools=("home-manager" "chezmoi" "stow" "direnv")
for tool in "${optional_tools[@]}"; do
  if command -v "$tool" >/dev/null 2>&1; then
    echo "‚úÖ $tool: Available"
  else
    echo "‚ö†Ô∏è  $tool: Not found"
  fi
done

# =============================================================================
# Environment Status
# =============================================================================
echo ""
echo "üåê Environment Status:"
echo "   RIPPLE_ENV_ROOT: $RIPPLE_ENV_ROOT"
echo "   RIPPLE_ENV_CACHE: $RIPPLE_ENV_CACHE"
echo "   RIPPLE_ENV_CONFIG: $RIPPLE_ENV_CONFIG"
echo "   HOME_MANAGER_CONFIG: ${HOME_MANAGER_CONFIG:-Not configured}"

# =============================================================================
# Quick Setup Helpers
# =============================================================================
echo ""
echo "üìã Quick Commands:"
echo "   home-manager switch     # Apply home configuration"
echo "   pixi install            # Install project dependencies"
echo "   nix flake update        # Update Nix dependencies"
echo "   direnv reload           # Reload this environment"

# =============================================================================
# Local Overrides (Optional)
# =============================================================================
# Load local environment overrides if they exist
if [[ -f .envrc.local ]]; then
  echo ""
  echo "üîÑ Loading local overrides from .envrc.local"
  source .envrc.local
fi

# =============================================================================
# Success Message
# =============================================================================
echo ""
echo "üéâ ripple-env development environment loaded successfully!"
echo "   Run 'direnv reload' if you make changes to .envrc"
echo "   Run 'home-manager switch' to apply user configuration"