# NATS Deployment for FlexStack
# High-performance event bus
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nats-config
  namespace: flexstack-messaging
  labels:
    app.kubernetes.io/name: nats
    app.kubernetes.io/component: messaging
    app.kubernetes.io/part-of: flexstack
data:
  nats.conf: |
    # NATS Server Configuration
    port: 4222
    http_port: 8222
    cluster {
      port: 6222
    }
    jetstream {
      store_dir: /data
      max_memory_store: 1G
      max_file_store: 10G
    }
    # Enable monitoring
    server_name: flexstack-nats
    # Logging
    debug: false
    trace: false
    logtime: true
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nats-data
  namespace: flexstack-messaging
  labels:
    app.kubernetes.io/name: nats
    app.kubernetes.io/component: messaging
    app.kubernetes.io/part-of: flexstack
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: standard
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nats
  namespace: flexstack-messaging
  labels:
    app.kubernetes.io/name: nats
    app.kubernetes.io/component: messaging
    app.kubernetes.io/part-of: flexstack
spec:
  serviceName: nats
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: nats
  template:
    metadata:
      labels:
        app.kubernetes.io/name: nats
        app.kubernetes.io/component: messaging
        app.kubernetes.io/part-of: flexstack
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8222"
        prometheus.io/path: "/varz"
    spec:
      containers:
        - name: nats
          image: nats:2.10.24-alpine
          args:
            - --config
            - /etc/nats/nats.conf
          ports:
            - containerPort: 4222
              name: client
            - containerPort: 8222
              name: monitoring
            - containerPort: 6222
              name: cluster
          volumeMounts:
            - name: nats-config
              mountPath: /etc/nats
            - name: nats-data
              mountPath: /data
          resources:
            limits:
              memory: 1Gi
              cpu: "1"
            requests:
              memory: 256Mi
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8222
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8222
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: nats-config
          configMap:
            name: nats-config
        - name: nats-data
          persistentVolumeClaim:
            claimName: nats-data
---
apiVersion: v1
kind: Service
metadata:
  name: nats
  namespace: flexstack-messaging
  labels:
    app.kubernetes.io/name: nats
    app.kubernetes.io/component: messaging
    app.kubernetes.io/part-of: flexstack
spec:
  type: ClusterIP
  ports:
    - port: 4222
      targetPort: 4222
      name: client
    - port: 8222
      targetPort: 8222
      name: monitoring
    - port: 6222
      targetPort: 6222
      name: cluster
  selector:
    app.kubernetes.io/name: nats
